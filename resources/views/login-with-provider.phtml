<?php

declare(strict_types=1);

use Fisharebest\Webtrees\Http\RequestHandlers\HomePage;
use Fisharebest\Webtrees\I18N;
use Fisharebest\Webtrees\Tree;
use Jefferson49\Webtrees\Module\OAuth2Client\Factories\AuthorizationProviderFactory;
use Jefferson49\Webtrees\Module\OAuth2Client\LoginWithAuthorizationProviderAction;


/**
 * @var Tree|null $tree
 * @var string    $url
 */


$url = $url ?? route(HomePage::class);

$provider_names = AuthorizationProviderFactory::getAuthorizatonProviderNames();
$login_button_labels = [];

//Remove any provider from list, for which no sufficient config is available
foreach($provider_names as $class_name => $provider_name) {
    if(AuthorizationProviderFactory::readProviderOptionsFromConfigFile($provider_name) === []) {
        unset($provider_names[$class_name]);
    }
}

//Get login button labels for all providers
foreach($provider_names as $class_name => $provider_name) {
    $provider = AuthorizationProviderFactory::make($provider_name, '');
    $login_button_labels[$provider_name] = $provider->getLoginButtonLabel();
}

//Alphabetically sort provider labels
uasort($login_button_labels, function (string $a, string $b) {
    return strcmp($a, $b);
});

?>

<?php if (sizeof($provider_names) > 0) : ?>
    <div class="row mb-3">
        <label class="col-sm-3 col-form-label wt-page-options-label">
            <?= I18N::translate('Sign in with authorization provider') ?>
        </label>
        <div class="col-sm-9 wt-page-options-value">
            <form method="post">
                <?php foreach ($login_button_labels as $provider_name => $login_button_label) : ?>

                    <a href="<?= e(route(LoginWithAuthorizationProviderAction::class, [
                            'tree'          => $tree instanceof Tree ? $tree->name() : null,
                            'url'           => $url,
                            'provider_name' => $provider_name,
                        ])) ?>" type="submit" class="btn btn-secondary">
                        <?= $login_button_label ?>
                    </a>
                <?php endforeach ?>
                <?= csrf_field() ?>
            </form>
        </div>
    </div>
<?php endif ?>
